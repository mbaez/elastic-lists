var ElasticBuilder=function(){this.grafo={},this.countMap={},this.panelTemplate='<div class="panel panel-default "></div>',this.panelHeadTemplate='<div class="panel-heading"></div>',this.panelBodyTemplate='<div class="panel-body"/></div>',this.hideClass="hide-element"};ElasticBuilder.prototype.initialize=function(options){for(var attr in options)this[attr]=options[attr];this.buildContainer(),this.buildList(),this.bindEvents(),this.setSelected()},ElasticBuilder.prototype.beforeSearch=function(value){return value},ElasticBuilder.prototype.genId=function(value){value=value.toString(),value=value.trim().toLowerCase();var i,chr,len,hash=0;if(0==value.length)return hash;for(i=0,len=value.length;len>i;i++)chr=value.charCodeAt(i),hash=(hash<<5)-hash+chr,hash|=0;return hash},ElasticBuilder.prototype.getKey=function(first,second){return this.genId(this.parseValue(first))+"X"+this.genId(this.parseValue(second))},ElasticBuilder.prototype.genColumnId=function(attr){return attr+"X"+this.genId(attr)},ElasticBuilder.prototype.parseValue=function(value){return null==value||"undefined"==typeof value||0==value.length?"Desconocido":value},ElasticBuilder.prototype.isIn=function(node,filters){var resp=!0;for(var key in filters)this.genId(this.parseValue(node[key]))!=this.genId(this.parseValue(filters[key]))&&(resp=!1);return resp},ElasticBuilder.prototype.getFilters=function(){var $filters=this.el.find(".active"),filters={};return $filters.each(function(){var key=$(this).parent().attr("data-name"),value=$(this).find(":not(.badge)").parent().attr("data-value");filters[key]=value}),filters},ElasticBuilder.prototype.applyFilters=function($target){var nodes,map={},attrKey=null,filters=this.getFilters();for(var key in filters)attrKey=this.getKey(key,filters[key]);if(null==attrKey){this.el.find("li").removeClass(this.hideClass);for(var elId in this.countMap)this.el.find("#"+elId).text(this.countMap[elId]);return void("undefined"!=typeof this.onchange&&this.onchange({}))}nodes=this.grafo[attrKey],attrKey=attrKey.split("X");var attr=($target.find(".badge").attr("id"),attrKey[0]),key=attrKey[1];this.el.find("li:not(.active)").addClass(this.hideClass);for(var i=0;i<nodes.length;i++)if(this.isIn(nodes[i],filters))for(var j=0;j<this.columns.length;j++){var nodeKey=this.columns[j].attr,elId=this.getKey(nodeKey,nodes[i][nodeKey]),$el=$("#"+elId).parent(),count=this.count(map,elId,nodes[i]);nodeKey!=attr&&$el.removeClass(this.hideClass),$("#"+elId).text(count)}"undefined"==typeof this.onchange||"undefined"!=typeof this.settingDefault&&this.settingDefault||this.onchange(filters),this.settingDefault=!1},ElasticBuilder.prototype.clickHandler=function(el){var thiz=this,$target=$(el),undo=!1,clazz=$target.attr("class");clazz.indexOf(this.hideClass)>=0||(clazz.indexOf("active")>=0?($target.removeClass("active"),undo=!0):($target.addClass("active"),$target.removeClass(this.hideClass)),"undefined"!=typeof this.hasFilter&&this.hasFilter&&this.el.find("input").each(function(){$(this).val(""),thiz.cleanFilters()}),this.applyFilters($target,undo))},ElasticBuilder.prototype.setSelected=function(options){var args="undefined"==typeof options?this.defaultValue:options;if("undefined"!=typeof args)for(var attr in args){var value=args[attr];value=this.parseValue(value);var key=value.toString().toLowerCase(),elKey=this.getKey(attr,key),$target=$("#"+elKey);$target.length>0&&(this.settingDefault=!0,$target.parent().click())}},ElasticBuilder.prototype.buildContainer=function(){var len="vertical"===this.align?12:parseInt(12/this.columns.length),$container=$("<div class='list-container'></div>"),$input=$("<input type='text' class='elastic-filter'>"),$panel=$(this.panelTemplate);$container.addClass("col-md-"+len);for(var $head=$(this.panelHeadTemplate),j=($(this.panelBodyTemplate),0);j<this.columns.length;j++){var attr=this.columns[j].attr,$ulContainer=$container.clone(),$ulPanel=$panel.clone(),$ulhead=$head.clone();$ulhead.text(this.columns[j].title);var $ul=$("<ul class='list-group'></ul>");if($ul.attr("id",this.genColumnId(attr)),$ul.attr("data-name",attr),$ulPanel.append($ulhead),"undefined"!=typeof this.hasFilter&&this.hasFilter){var $ulFilter=$input.clone();$ulFilter.attr("placeholder",this.columns[j].title),$ulPanel.append($ulFilter);var $style=$("<style></style>");$style.attr("class",this.genColumnId(attr)),$ulPanel.append($style)}$ulPanel.append($ul),$ulContainer.append($ulPanel),this.el.append($ulContainer)}},ElasticBuilder.prototype.count=function(countMap,key,node){var hasCountColumn="undefined"==typeof this.countColumn?!1:!0;return"undefined"==typeof countMap[key]?(countMap[key]=hasCountColumn?node[this.countColumn]:1,countMap[key]):(countMap[key]+=hasCountColumn?node[this.countColumn]:1,countMap[key])},ElasticBuilder.prototype.buildList=function(){for(var count=0,i=0;i<this.data.length;i++)for(var j=0;j<this.columns.length;j++){var attr=this.columns[j].attr,value=this.data[i][attr];value=this.parseValue(value);var key=value.toString().toLowerCase(),elKey=this.getKey(attr,key);if("undefined"==typeof this.countMap[elKey]){count=this.count(this.countMap,elKey,this.data[i]),this.grafo[elKey]=[];var $ul=this.el.find("#"+this.genColumnId(attr)),$li=$("<li class='list-group-item'></li>"),$span=$("<div></div>"),$badge=$span.clone();$badge.addClass("badge"),$badge.attr("id",elKey),$badge.text(count),$li.attr("data-value",value.toString().toLowerCase()),"function"==typeof this.columns[j].formatter&&(value=this.columns[j].formatter(value,this.data[i])),tmpValue=value.toString().toLowerCase(),tmpValue=this.beforeSearch(tmpValue),$li.attr("data-formatted",tmpValue),$span.text(value),$span.addClass("elastic-data"),$li.append($badge),$li.append($span),$ul.append($li)}else count=this.count(this.countMap,elKey,this.data[i]),this.el.find("#"+elKey).text(count);this.grafo[elKey].push(this.data[i])}},ElasticBuilder.prototype.bindEvents=function(){var thiz=this;this.el.find("li").on("click",function(){thiz.clickHandler(this)}),"undefined"!=typeof this.hasFilter&&this.hasFilter&&this.el.find("input.elastic-filter").on("keyup",function(e){thiz.findData(e)})},ElasticBuilder.prototype.findData=function(event){event.stopPropagation();var $input=$(event.target),$column=$input.parent().find("ul"),columnAttr=$column.attr("data-name"),columnId=$column.attr("id"),data=$input.val().trim(),$style=this.el.find("."+columnId);if(data.length>0){data=data.toLocaleLowerCase(),data=this.beforeSearch(data,columnAttr);var rule=" ul#"+columnId+' li[data-formatted*="'+data+'"]{display:block;} ';rule+=" ul#"+columnId+' li:not([data-formatted*="'+data+'"]){display:none;}',$style.html(rule)}else $style.html("")},ElasticBuilder.prototype.cleanFilters=function(){this.el.find("style").each(function(){$(this).html("")})};var ElasticList=function(options){this.builder=new ElasticBuilder(options),this.builder.initialize(options)};ElasticList.prototype.getFilters=function(){return this.builder.getFilters()},ElasticList.prototype.setSelected=function(options){return this.builder.setSelected(options)},ElasticList.prototype.clean=function(){var slecteds=this.getFilters();this.builder.setSelected(slecteds)};